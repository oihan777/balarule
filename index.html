<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balatro Roulette - Hard Reset</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --table-color: #2e5c3e;
            --table-border: #3d2817;
            --accent-gold: #ffd700;
            --accent-red: #e74c3c;
            --accent-black: #2c3e50;
            --text-light: #ecf0f1;
            --card-bg: #fff;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
        }

        body.skin-vip {
            --bg-color: #0d0d0d;
            --table-color: #1a1a2e;
            --accent-gold: #00d2ff;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-light);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            transition: background 0.5s;
        }

        /* --- Header --- */
        header {
            background: rgba(0, 0, 0, 0.9);
            padding: 5px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent-gold);
            z-index: 10;
            height: 70px;
        }
        .header-left { display: flex; flex-direction: column; }
        .brand { 
            font-family: 'VT323', monospace; 
            font-size: 1.8rem; 
            font-weight: bold; 
            color: var(--accent-gold); 
            text-shadow: 2px 2px 0px #e74c3c;
            line-height: 1;
        }
        .mode-status { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
        .mode-status span { color: var(--accent-gold); font-weight: bold; }

        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        .round-progress-container {
            display: none;
            flex-direction: column;
            width: 200px;
            margin-right: 15px;
        }
        .round-text { font-size: 0.8rem; display: flex; justify-content: space-between; font-family: 'VT323'; }
        .progress-bar-bg {
            width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #555; margin-top: 3px;
        }
        .progress-bar-fill {
            height: 100%; background: linear-gradient(90deg, #e74c3c, #f1c40f); width: 0%; transition: width 0.5s ease-out;
        }

        .btn-start-run, .btn-shop, .btn-slot, .btn-deck {
            border: none; padding: 5px 15px; border-radius: 5px;
            font-weight: bold; color: #fff; cursor: pointer; font-family: 'VT323', monospace; font-size: 1.1rem;
            box-shadow: 2px 2px 0px #000; transition: transform 0.1s;
        }
        .btn-start-run { background: linear-gradient(45deg, #2ecc71, #27ae60); box-shadow: 0 4px 0 #1e8449; }
        .btn-shop { background: var(--accent-gold); color: #000; }
        .btn-slot { background: var(--neon-pink); animation: pulse 2s infinite; }
        .btn-deck { background: #9b59b6; }

        .balance-box {
            background: #000; padding: 2px 10px; border: 2px solid var(--accent-gold);
            color: var(--accent-gold); font-family: 'VT323', monospace; font-size: 1.5rem;
        }

        /* --- Main Layout --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(circle, #2e4053 0%, #000 100%);
            padding: 20px;
        }

        .jimbo-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(124, 56, 168, 0.5));
        }

        .dealer-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            overflow: hidden;
            background: #000;
        }
        .dealer-img { width: 100%; height: 100%; object-fit: cover; }

        canvas#rouletteCanvas {
            border-radius: 50%; box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border: 10px solid #3d2817;
            z-index: 5;
        }

        .result-display {
            margin-top: 20px;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid var(--accent-gold);
        }
        .result-number {
            font-family: 'VT323', monospace; font-size: 4rem; line-height: 1;
            color: #fff; text-shadow: 0 0 10px #fff;
        }

        .right-panel {
            flex: 1.5;
            background-color: var(--table-color);
            border-left: 10px solid var(--table-border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMmU1YzNlIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMzZDQ4MzAiLz4KPC9zdmc+');
        }

        .active-cards-section {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            min-height: 130px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
            border: 1px dashed #555;
            align-items: center;
        }
        .balatro-card {
            min-width: 90px;
            height: 120px;
            background: #fff;
            border-radius: 8px;
            border: 2px solid #333;
            color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: all 0.5s ease-out;
            padding: 5px;
            flex-shrink: 0;
            cursor: help;
        }
        .balatro-card.fading-out {
            opacity: 0;
            transform: scale(0.5) translateY(20px);
            pointer-events: none;
        }
        
        .balatro-card:hover { 
            transform: scale(1.1) translateY(-5px); 
            z-index: 100;
            background-color: #f9f9f9;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        .card-title { font-weight: bold; text-align: center; width: 100%; border-bottom: 1px solid #ccc; padding-bottom: 2px; font-size: 0.9rem;}
        .card-mult { font-size: 1.5rem; font-weight: bold; margin: 5px 0; text-align: center; }
        .card-effect { font-size: 0.7rem; text-align: center; line-height: 1.1; color: #333; font-family: 'Segoe UI', sans-serif; font-weight: bold; background: rgba(255,255,255,0.8); width: 100%; border-radius: 3px; padding: 2px;}
        
        .balatro-card.red { background: #ffadad; border-color: #d90429; color: #d90429; }
        .balatro-card.blue { background: #a0c4ff; border-color: #0077b6; color: #0077b6; }
        .balatro-card.black { background: #333; border-color: #000; color: #fff; }
        .balatro-card.gold { background: linear-gradient(135deg, #ffd700, #fff); border-color: #d4ac0d; color: #000; font-weight: bold; border-width: 3px; }
        .balatro-card.legendary { 
            background: linear-gradient(135deg, #8e44ad, #000); 
            border: 2px solid var(--neon-pink); 
            color: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink);
        }

        .remove-card {
            position: absolute; top: -8px; right: -8px; background: #c0392b; color: white;
            border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center;
            font-size: 14px; cursor: pointer; z-index: 101; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .betting-board {
            display: grid; grid-template-columns: 30px repeat(3, 1fr); gap: 2px;
            background: #fff; padding: 2px; border-radius: 4px;
        }
        .bet-cell {
            background: var(--table-color); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center; height: 45px;
            font-weight: bold; cursor: pointer; position: relative;
        }
        .bet-cell.red { background-color: var(--accent-red); }
        .bet-cell.black { background-color: var(--accent-black); }
        .bet-cell.green { background-color: #27ae60; grid-column: 1 / -1; }
        
        .outside-bets { display: flex; gap: 5px; margin-top: 5px; }
        .bet-btn { flex: 1; padding: 10px; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; border-radius: 4px; background: #333; }
        .btn-red { background-color: var(--accent-red); }
        .btn-black { background-color: var(--accent-black); }

        .chip-marker {
            position: absolute; width: 20px; height: 20px; background: var(--accent-gold);
            color: #000; border-radius: 50%; font-size: 9px; display: flex;
            justify-content: center; align-items: center; border: 1px dashed #fff;
            pointer-events: none; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .powers-area {
            background: rgba(0,0,0,0.4);
            padding: 5px;
            border-radius: 8px;
            border: 1px solid var(--neon-blue);
            margin-bottom: 5px;
        }
        .powers-title { font-family:'VT323'; color:var(--neon-blue); text-align:center; font-size:1rem; margin:0; }
        .powers-list { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; min-height: 30px; }
        .power-btn {
            padding: 3px 8px; font-size: 0.8rem; border: 1px solid var(--neon-blue); background: transparent;
            color: var(--neon-blue); cursor: pointer; border-radius: 4px;
        }
        .power-btn:hover:not(:disabled) { background: var(--neon-blue); color: #000; }
        .prediction-display {
            font-family: 'VT323'; font-size: 1.2rem; color: var(--neon-pink); text-shadow: 0 0 5px var(--neon-pink);
            text-align: center; height: 25px; opacity: 0; transition: opacity 0.3s;
        }

        .controls-area { margin-top: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .chip-selector { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .chip {
            width: 45px; height: 45px; border-radius: 50%; border: 3px dashed white;
            display: flex; justify-content: center; align-items: center; font-weight: bold;
            cursor: pointer; transition: transform 0.1s; font-size: 0.8rem;
        }
        .chip.selected { transform: scale(1.15); border: 2px solid #fff; box-shadow: 0 0 10px #fff; }
        .chip-10 { background: #3498db; }
        .chip-50 { background: #9b59b6; }
        .chip-100 { background: #e74c3c; }
        .chip-500 { background: #2c3e50; color: #ffd700; border-color: #ffd700; }
        .chip-1000 { background: linear-gradient(135deg, #f1c40f, #fff); color: #000; display: none; }
        .chip-allin {
            background: linear-gradient(135deg, #e74c3c 50%, #2c3e50 50%);
            color: white;
            border: 3px solid #ffd700;
            font-size: 0.7rem;
            font-weight: 900;
            line-height: 1;
        }

        .actions { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .btn-spin { background: var(--accent-gold); color: #000; padding: 10px 40px; font-family: 'VT323', monospace; font-size: 1.5rem; border: none; border-radius: 5px; cursor: pointer; }
        .btn-spin:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* --- Aside --- */
        aside { width: 220px; background: #151515; border-left: 2px solid #333; display: flex; flex-direction: column; }
        .panel-header { padding: 10px; background: #0f0f0f; font-size: 0.8rem; color: #666; border-bottom: 1px solid #333; font-family: 'VT323', monospace; text-transform: uppercase; }
        .game-log { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; font-family: 'VT323', monospace; }
        .log-entry { margin-bottom: 6px; color: #aaa; }
        .log-dealer { color: #ffadad; }
        .log-jimbo { color: #bd93f9; }
        .log-system { color: #f1c40f; }
        .log-slot { color: var(--neon-pink); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #222; width: 90%; max-width: 900px;
            border-radius: 10px; border: 4px solid #fff;
            padding: 30px; position: relative; text-align: center;
            background-image: radial-gradient(#333 10%, transparent 10%); background-size: 20px 20px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title { font-family: 'VT323'; font-size: 3rem; margin: 0; color: var(--accent-gold); text-transform: uppercase; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px;}
        .shop-item { background: rgba(0,0,0,0.7); border: 2px solid #555; padding: 10px; text-align: center; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;}
        .shop-item.passive { border-color: #9b59b6; }
        .shop-item.active { border-color: var(--neon-blue); }
        .item-price { color: var(--accent-gold); font-size: 1.2rem; margin: 10px 0; font-family: 'VT323', monospace; }
        .btn-buy { background: #fff; color: #000; border: none; padding: 8px; width: 100%; cursor: pointer; font-weight: bold; }

        /* --- Slot Machine Specific --- */
        .slot-container {
            background: #222;
            border: 8px solid #d4ac0d;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 0 50px rgba(212, 172, 13, 0.3);
        }
        .slot-reels { display: flex; gap: 10px; background: #000; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .reel { width: 80px; height: 100px; background: #fff; display: flex; justify-content: center; align-items: center; font-size: 3rem; border: 2px solid #ccc; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .slot-info { color: #aaa; font-size: 1rem; margin-bottom: 15px; font-family: 'VT323'; }
        .slot-cost { color: #e74c3c; font-weight: bold; }
        .btn-slot-spin {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white; border: none; padding: 15px 40px; font-family: 'VT323'; font-size: 2rem;
            border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #922b21; border: 2px solid #fff; transition: 0.1s;
        }
        .btn-slot-spin:active { transform: translateY(5px); box-shadow: none; }
        .btn-slot-spin:disabled { background: #555; box-shadow: none; cursor: not-allowed; transform: translateY(5px); }
        .slot-legend { margin-top: 20px; font-size: 0.8rem; color: #888; text-align: left; width: 100%;}

        /* --- Animaciones --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 2px 2px 0px #000; } 50% { transform: scale(1.05); box-shadow: 2px 2px 0px #555; } 100% { transform: scale(1); box-shadow: 2px 2px 0px #000; } }
        
        #notification-area { position: fixed; top: 80px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .toast { background: #fff; color: #000; padding: 15px; border-radius: 5px; border-left: 5px solid #000; font-family: 'VT323', monospace; font-size: 1.2rem; box-shadow: 5px 5px 0 rgba(0,0,0,0.5); animation: slideIn 0.3s; }

        @media (max-width: 900px) {
            main { flex-direction: column; }
            .jimbo-container { display: none; }
            aside { display: none; }
            .header-controls { flex-direction: column; gap: 5px; }
            .btn-slot { display: none; }
        }
    </style>
</head>
<body>

    <!-- Shop Modal -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal-content" style="max-width: 900px;">
            <span style="position:absolute; right:20px; top:20px; cursor:pointer; font-size:2rem;" onclick="toggleShop()">&times;</span>
            <h2 class="modal-title" style="font-size:2rem; color: var(--neon-blue);">TIENDA & MAZO</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <button class="btn-deck" style="font-size:1.5rem; padding:10px 30px; display:inline-block;" onclick="buyRandomCard()">üé¥ ROBAR CARTA (150‚Ç≥)</button>
            </div>
            <h3 style="color:#aaa; font-family:'VT323'">OBJETOS ESPECIALES</h3>
            <div class="shop-grid" id="shop-container"></div>
        </div>
    </div>

    <!-- Slot Machine Modal -->
    <div class="modal-overlay" id="slot-modal">
        <div class="modal-content" style="background: #1a1a1a;">
            <span style="position:absolute; right:20px; top:20px; cursor:pointer; font-size:2rem; color:#fff;" onclick="toggleSlot()">&times;</span>
            <h2 class="modal-title" style="color:var(--accent-gold); text-shadow: 2px 2px 0px #e74c3c;">TRAGAPERRAS</h2>
            <div class="slot-container">
                <div class="slot-info">
                    COSTE: <span class="slot-cost">1 CARTA ALEATORIA DE TU MANO</span>
                </div>
                <div class="slot-reels">
                    <div class="reel" id="reel1">üçí</div>
                    <div class="reel" id="reel2">üçí</div>
                    <div class="reel" id="reel3">üçí</div>
                </div>
                <button class="btn-slot-spin" id="btn-slot-action" onclick="playSlotMachine()">JUGAR</button>
                <div class="slot-legend">
                    <strong>PREMIOS:</strong><br>
                    üçíüçíüçí = +500 Fichas<br>
                    üçãüçãüçã = +1000 Fichas<br>
                    üíéüíéüíé = +3000 Fichas<br>
                    üëπüëπüëπ = Carta Muy Poderosa<br>
                    üÉèüÉèüÉè = CARTA LEGENDARIA (Exclusiva)
                </div>
            </div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div class="modal-overlay" id="levelup-modal">
        <div class="modal-content">
            <h2 class="modal-title">¬°RONDA SUPERADA!</h2>
            <div class="modal-msg">
                Has alcanzado el objetivo.<br>
                <span style="color:#2ecc71; font-size:1.5rem;">Preparando siguiente desaf√≠o...</span>
            </div>
            <button class="btn-modal-primary" onclick="nextRound()">CONTINUAR</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal-overlay" id="gameover-modal">
        <div class="modal-content" style="border-color:#e74c3c;">
            <h2 class="modal-title" style="color:#e74c3c;">GAME OVER</h2>
            <div class="modal-msg">
                Te has quedado sin fichas en la ronda <span id="final-round">1</span>.<br>
                Tus cartas se han desvanecido en el vac√≠o.
            </div>
            <button class="btn-modal-primary" onclick="resetGame()">REINTENTAR</button>
        </div>
    </div>

    <header>
        <div class="header-left">
            <div class="brand">BALATRO <span style="color:var(--neon-pink)">CHAOS</span></div>
            <div class="mode-status" id="mode-status">MODO: <span>LIBRE</span></div>
        </div>
        <div class="header-controls">
            <div class="round-progress-container" id="round-progress-ui">
                <div class="round-text">
                    <span>R <span id="round-num">1</span></span>
                    <span>OBJ: <span id="round-goal-display">1500</span></span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
            </div>

            <button class="btn-start-run" onclick="startRun()">NUEVO RETO</button>
            <button class="btn-shop" onclick="toggleShop()">TIENDA</button>
            <button class="btn-slot" onclick="toggleSlot()">TRAGAPERRAS</button>
            <div class="balance-box">‚Ç≥ <span id="user-balance">1000</span></div>
        </div>
    </header>

    <main>
        <section class="left-panel">
            <div class="dealer-container">
                <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=AnimeDealer&backgroundColor=transparent" class="dealer-img" alt="Dealer">
            </div>

            <canvas id="rouletteCanvas" width="300" height="300"></canvas>

            <div class="result-display">
                <div class="result-number" id="display-result">-</div>
                <div style="font-size:0.8rem; color:#aaa;">MULTIPLICADOR: <span id="total-mult-display" style="color:#e74c3c">x1</span></div>
            </div>

            <div class="jimbo-container" id="jimbo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="30" width="60" height="50" rx="20" fill="#7c38a8" stroke="#000" stroke-width="3"/>
                    <rect x="30" y="60" width="40" height="5" fill="#5a2980"/>
                    <rect x="30" y="70" width="40" height="5" fill="#5a2980"/>
                    <circle cx="50" cy="55" r="12" fill="#ffd700" stroke="#000" stroke-width="2"/>
                    <circle id="jimbo-pupil" cx="50" cy="55" r="5" fill="#000"/>
                    <path id="jimbo-eyelid" d="M 35 50 Q 50 40 65 50" fill="none" stroke="#000" stroke-width="0" opacity="0.5"/>
                </svg>
            </div>
        </section>

        <section class="right-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-family:'VT323'; font-size:1.2rem; color:#fff;">CARTAS EN MANO (CONSUMIBLES)</span>
                <button onclick="clearCards()" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:0.8rem;">Descartar Todo</button>
            </div>
            <div class="active-cards-section" id="active-cards">
                <div style="color:#666; margin:auto; font-size:0.9rem; font-style:italic;">Sin cartas... ¬°Ve a la tienda!</div>
            </div>

            <div class="powers-area">
                <h4 class="powers-title">PODERES ESPECIALES</h4>
                <div class="powers-list" id="powers-list">
                    <span style="color:#555; font-size:0.8rem; font-family:'VT323'">Sin poderes activos...</span>
                </div>
                <div id="prediction-box" class="prediction-display"></div>
            </div>

            <div class="betting-board" id="numbers-grid">
                <div class="bet-cell green" onclick="placeBet('number', 0)">0</div>
            </div>

            <div class="outside-bets">
                <button class="bet-btn btn-red" onclick="placeBet('color', 'red')">ROJO</button>
                <button class="bet-btn btn-black" onclick="placeBet('color', 'black')">NEGRO</button>
            </div>

            <div class="controls-area">
                <div class="chip-selector">
                    <div class="chip chip-10 selected" onclick="selectChip(10, this)">10</div>
                    <div class="chip chip-50" onclick="selectChip(50, this)">50</div>
                    <div class="chip chip-100" onclick="selectChip(100, this)">100</div>
                    <div class="chip chip-500" onclick="selectChip(500, this)">500</div>
                    <div class="chip chip-1000" id="chip-1000" onclick="selectChip(1000, this)">1K</div>
                    <!-- NUEVA FICHA ALL IN -->
                    <div class="chip chip-allin" onclick="selectChip('all_in', this)">ALL<br>IN</div>
                </div>
                <div class="actions">
                    <button class="btn-spin" id="spin-btn" onclick="spinWheel()">JUGAR</button>
                </div>
            </div>
        </section>

        <aside>
            <div class="panel-header">Sala de Chat</div>
            <div class="game-log" id="game-log"></div>
        </aside>
    </main>

    <div id="notification-area"></div>

    <script>
        // --- Configuraci√≥n y Estado ---
        const gameState = {
            balance: parseInt(localStorage.getItem('balatro_balance')) || 1000,
            currentBets: {},
            selectedChipValue: 10,
            isSpinning: false,
            rotation: 0,
            speed: 0,
            wheelNumbers: [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26],
            activeCards: [], 
            inventory: JSON.parse(localStorage.getItem('balatro_inventory')) || [],
            isRunMode: JSON.parse(localStorage.getItem('balatro_isRun')) || false,
            currentRound: parseInt(localStorage.getItem('balatro_round')) || 1,
            roundGoal: parseInt(localStorage.getItem('balatro_goal')) || 1500,
            predeterminedResult: null,
            seerPrice: parseInt(localStorage.getItem('balatro_seerPrice')) || 5000 // Precio din√°mico
        };

        // --- Objetos de Tienda ---
        const shopItems = [
            { id: 'goldChip', name: 'Ficha Platino', price: 5000, desc: 'Desbloquea apuesta de 1000.', type: 'unlock', target: 'chip-1000' },
            { id: 'lifeInsurance', name: 'Seguro de Vida', price: 2000, desc: 'Salva de la bancarrota (+500).', type: 'passive' },
            { id: 'vipSkin', name: 'Skin Cyberpunk', price: 10000, desc: 'Cambia el tema visual.', type: 'cosmetic', target: 'skin-vip' },
            { id: 'seerPower', name: 'Ojo de la Mente', price: 5000, desc: 'V√© el n√∫mero ganador (1 solo uso).', type: 'active', cooldown: 0 },
            { id: 'loanShark', name: 'Prestamista', price: 0, desc: 'Consigue 2000 fichas ya, pero pierde 100/5s.', type: 'passive_debt' },
            { id: 'cryptoMiner', name: 'Minero Cripto', price: 8000, desc: 'Gana +50 fichas pasivamente cada 10s.', type: 'passive_income' }
        ];

        // --- Cartas ---
        const cardPool = [
            { type: 'mult', mult: 2, condition: 'red', name: 'x2 Rojo', color: 'red', desc: 'Ganancias x2 si sale Rojo.' },
            { type: 'mult', mult: 2, condition: 'black', name: 'x2 Negro', color: 'black', desc: 'Ganancias x2 si sale Negro.' },
            { type: 'mult', mult: 5, condition: 'any', name: 'x5 Global', color: 'blue', desc: 'Multiplica CUALQUIER victoria x5.' },
            { type: 'mult', mult: 10, condition: 'zero', name: 'Jackpot 0', color: 'red', desc: 'x10 si sale el 0.' },
            { type: 'risk', mult: 15, condition: 'devil_coin', name: 'Moneda Diablo', color: 'gold', desc: '50% de x15 o 50% de perder todo.' },
            { type: 'chaos', mult: 0, condition: 'any', name: 'Dios del Caos', color: 'black', desc: 'Mult aleatorio (0-20) cada giro.' },
            { type: 'echo', mult: 1, condition: 'any', name: 'Bola Fantasma', color: 'blue', desc: '30% prob de giro gratis si ganas.' },
            { type: 'refund', mult: 0, condition: 'lose', name: 'Martingala', color: 'red', desc: 'Recupera 50% de apuestas si pierdes.' },
            { type: 'conversion', mult: 2, condition: 'any', name: 'Alquimia', color: 'gold', desc: 'Si pierdes por color, ganas igual.' }
        ];

        const slotExclusiveCards = [
            { type: 'legendary', mult: 100, condition: 'number', name: 'Exodia', color: 'legendary', desc: 'x100 SI aciertas un n√∫mero exacto.' },
            { type: 'legendary', mult: 0, condition: 'any', name: 'El Duende', color: 'legendary', desc: 'Fuerza a que salga el 0 (100%).' },
            { type: 'legendary', mult: 0, condition: 'any', name: 'Duplicador', color: 'legendary', desc: 'Duplica tu balance actual al ganar.' },
            { type: 'legendary', mult: 0, condition: 'any', name: 'Clon', color: 'legendary', desc: 'Gana +50 fichas por cada carta en mano.' },
            { type: 'legendary', mult: 0, condition: 'any', name: 'Tiempo', color: 'legendary', desc: 'A√±ade +500 fichas tras cada giro.' }
        ];

        const colors = { red: [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36], black: [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35], green: [0] };
        
        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const jimboPupil = document.getElementById('jimbo-pupil');
        const jimboEyelid = document.getElementById('jimbo-eyelid');
        const progressBarFill = document.getElementById('progress-fill');
        
        let minerInterval = null;
        let debtInterval = null;

        // --- Inicializaci√≥n ---
        window.onload = () => {
            loadInventory();
            initBoard();
            drawWheel();
            renderShop();
            updateBalanceUI();
            updateRoundUI();
            renderPowers();
            startPassiveEffects();

            setTimeout(() => { 
                if(gameState.isRunMode) {
                    if (gameState.balance >= gameState.roundGoal) autoAdvanceCheckOnLoad();
                    else showToast(`Bienvenido de nuevo. Ronda ${gameState.currentRound}`, "success");
                } else {
                    showToast("Modo Libre Activado", "info");
                }
            }, 1000);
            
            log("Dealer", "¬°La mesa est√° servida! Las cartas se consumen al usar.");
        };

        function saveGame() {
            localStorage.setItem('balatro_balance', gameState.balance);
            localStorage.setItem('balatro_inventory', JSON.stringify(gameState.inventory));
            localStorage.setItem('balatro_isRun', gameState.isRunMode);
            localStorage.setItem('balatro_round', gameState.currentRound);
            localStorage.setItem('balatro_goal', gameState.roundGoal);
            localStorage.setItem('balatro_seerPrice', gameState.seerPrice); // Guardar precio escalado
        }

        // --- Efectos Pasivos ---
        function startPassiveEffects() {
            // Limpiar intervalos previos para evitar duplicados al recargar
            if(minerInterval) clearInterval(minerInterval);
            if(debtInterval) clearInterval(debtInterval);

            if (gameState.inventory.includes('cryptoMiner')) {
                minerInterval = setInterval(() => {
                    if(!gameState.isSpinning) {
                        gameState.balance += 50;
                        updateBalanceUI();
                        updateRoundUI();
                        showToast("+50‚Ç≥ (Miner√≠a)", "info");
                    }
                }, 10000);
            }

            if (gameState.inventory.includes('loanShark')) {
                debtInterval = setInterval(() => {
                    if(!gameState.isSpinning && gameState.balance > 0) {
                        const debt = Math.min(100, gameState.balance);
                        gameState.balance -= debt;
                        updateBalanceUI();
                        updateRoundUI();
                        showToast(`-100‚Ç≥ (Deuda)`, "error");
                        checkGameOver();
                    }
                }, 5000);
            }
        }

        // --- TRAGAPERRAS ---
        function toggleSlot() {
            const modal = document.getElementById('slot-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function playSlotMachine() {
            if (gameState.activeCards.length === 0) {
                showToast("¬°Necesitas cartas para jugar!", "error");
                return;
            }
            const btn = document.getElementById('btn-slot-action');
            btn.disabled = true;

            const randomIndex = Math.floor(Math.random() * gameState.activeCards.length);
            const sacrificedCard = gameState.activeCards.splice(randomIndex, 1)[0];
            renderActiveCards();
            showToast(`Sacrificaste: ${sacrificedCard.name}`, "warning");
            log("Sistema", `Tragaperras: sacrificada carta ${sacrificedCard.name}.`);

            const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
            const symbols = ['üçí', 'üçã', 'üíé', 'üëπ', 'üÉè'];
            
            let interval = setInterval(() => {
                reels.forEach(r => r.innerText = symbols[Math.floor(Math.random() * symbols.length)]);
            }, 100);

            setTimeout(() => {
                clearInterval(interval);
                const results = [
                    symbols[Math.floor(Math.random() * symbols.length)],
                    symbols[Math.floor(Math.random() * symbols.length)],
                    symbols[Math.floor(Math.random() * symbols.length)]
                ];
                if (Math.random() < 0.35) {
                    const matchSym = symbols[Math.floor(Math.random() * symbols.length)];
                    results[0] = matchSym; results[1] = matchSym; results[2] = matchSym;
                }
                reels[0].innerText = results[0]; reels[1].innerText = results[1]; reels[2].innerText = results[2];
                checkSlotWin(results);
                btn.disabled = false;
            }, 2000);
        }

        function checkSlotWin(results) {
            const [r1, r2, r3] = results;
            if (r1 === r2 && r2 === r3) {
                if (r1 === 'üçí') { gameState.balance += 500; showToast("¬°PREMIO! +500 Fichas", "success"); }
                else if (r1 === 'üçã') { gameState.balance += 1000; showToast("¬°GRAN PREMIO! +1000 Fichas", "success"); }
                else if (r1 === 'üíé') { gameState.balance += 3000; showToast("¬°MEGA DIAMANTE! +3000 Fichas", "success"); }
                else if (r1 === 'üëπ') {
                    const powerfulCard = cardPool[Math.floor(Math.random() * cardPool.length)];
                    gameState.activeCards.push(powerfulCard);
                    showToast(`¬°PREMIO CA√ìTICO! Carta: ${powerfulCard.name}`, "success");
                    log("Tragaperras", "Has ganado una carta poderosa.");
                } else if (r1 === 'üÉè') {
                    const legCard = slotExclusiveCards[Math.floor(Math.random() * slotExclusiveCards.length)];
                    gameState.activeCards.push(legCard);
                    showToast("¬°LEYENDA DESCUBIERTA!", "success");
                    log("Tragaperras", "¬°Has conseguido una carta LEGENDARIA!");
                }
                updateBalanceUI(); updateRoundUI(); renderActiveCards();
            } else { showToast("Nada esta vez...", "error"); }
        }

        // --- Poderes ---
        function renderPowers() {
            const container = document.getElementById('powers-list');
            container.innerHTML = '';
            shopItems.forEach(item => {
                if (gameState.inventory.includes(item.id) && item.type === 'active') {
                    const btn = document.createElement('button');
                    btn.className = 'power-btn';
                    btn.innerHTML = `<span>üëÅÔ∏è</span> ${item.name}`;
                    btn.onclick = () => useSeerPower();
                    container.appendChild(btn);
                }
            });
            if (container.innerHTML === '') container.innerHTML = '<span style="color:#555; font-size:0.8rem; font-family:"VT323"">Sin poderes activos...</span>';
        }

        function useSeerPower() {
            if (gameState.isSpinning) return;

            const randomIndex = Math.floor(Math.random() * gameState.wheelNumbers.length);
            gameState.predeterminedResult = gameState.wheelNumbers[randomIndex];
            const display = document.getElementById('prediction-box');
            const color = getColor(gameState.predeterminedResult);
            display.style.opacity = '1';
            display.innerHTML = `FUTURO: <span style="color:${color === 'red' ? '#e74c3c' : (color === 'black' ? '#333' : '#27ae60')}">${gameState.predeterminedResult}</span>`;
            
            log("Vidente", `El destino est√° escrito: ${gameState.predeterminedResult}`);
            showToast("El futuro revelado.", "success");

            // CONSUMIR EL PODER
            gameState.inventory = gameState.inventory.filter(id => id !== 'seerPower');
            saveGame();
            
            renderPowers();
            renderShop();
        }

        // --- Rondas ---
        function startRun() {
            if(gameState.isRunMode && !confirm("¬øReiniciar progreso de rondas?")) return;
            
            gameState.isRunMode = true;
            gameState.currentRound = 1;
            gameState.balance = 1000;
            gameState.activeCards = []; 
            gameState.roundGoal = 1500; 
            
            // REINICIAR MEJORAS E INVENTARIO COMPLETAMENTE
            gameState.inventory = [];
            gameState.seerPrice = 5000; // Resetear precio del ojo
            
            // Limpiar intervalos activos
            if(minerInterval) clearInterval(minerInterval);
            if(debtInterval) clearInterval(debtInterval);
            minerInterval = null;
            debtInterval = null;
            
            updateBalanceUI(); 
            updateRoundUI(); 
            renderActiveCards(); 
            loadInventory(); // Recargar UI para ocultar mejoras desbloqueadas
            renderShop(); // Recargar tienda con precios originales
            renderPowers(); // Limpiar botones de poder
            saveGame();
            
            showToast("¬°NUEVO RETO INICIADO! (Mejoras reiniciadas)", "success");
            log("Sistema", "Ronda 1 iniciada. Todas las mejoras han sido eliminadas.");
        }

        function updateRoundUI() {
            const modeText = document.querySelector('.mode-status span');
            const uiContainer = document.getElementById('round-progress-ui');
            if (gameState.isRunMode) {
                modeText.innerText = "RONDAS INFINITAS";
                uiContainer.style.display = 'flex';
                document.getElementById('round-num').innerText = gameState.currentRound;
                document.getElementById('round-goal-display').innerText = gameState.roundGoal;
                let pct = (gameState.balance / gameState.roundGoal) * 100;
                if (pct > 100) pct = 100;
                progressBarFill.style.width = `${pct}%`;
            } else {
                modeText.innerText = "LIBRE";
                uiContainer.style.display = 'none';
            }
        }

        function checkRoundCompletion() {
            if (!gameState.isRunMode) return;
            if (gameState.balance >= gameState.roundGoal) {
                setTimeout(() => {
                    document.getElementById('levelup-modal').style.display = 'flex';
                    setJimboEmotion('happy');
                }, 1000);
            }
        }

        function autoAdvanceCheckOnLoad() {
            let roundsSkipped = 0;
            while (gameState.balance >= gameState.roundGoal) {
                gameState.currentRound++;
                gameState.roundGoal = Math.floor(1500 + Math.pow(gameState.currentRound, 1.5) * 500);
                roundsSkipped++;
            }
            if (roundsSkipped > 0) {
                updateRoundUI(); saveGame();
                showToast(`Saldo excesivo. Avanzado ${roundsSkipped} rondas.`, "info");
            } else { showToast(`Bienvenido. Ronda ${gameState.currentRound}`, "success"); }
        }

        function nextRound() {
            document.getElementById('levelup-modal').style.display = 'none';
            let roundsSkipped = 0;
            do {
                gameState.currentRound++;
                gameState.roundGoal = Math.floor(1500 + Math.pow(gameState.currentRound, 1.5) * 500);
                roundsSkipped++;
            } while (gameState.balance >= gameState.roundGoal);
            updateRoundUI(); saveGame();
            if (roundsSkipped > 1) showToast(`¬°SALTASTE ${roundsSkipped} RONDAS!`, "success", true);
            else showToast(`RONDA ${gameState.currentRound} INICIADA`, "success");
            log("Sistema", `Comienza la Ronda ${gameState.currentRound}.`);
        }

        function checkGameOver() {
            if (!gameState.isRunMode) return;
            if (gameState.balance <= 0) {
                if (gameState.inventory.includes('lifeInsurance')) {
                    gameState.balance = 500;
                    gameState.inventory = gameState.inventory.filter(id => id !== 'lifeInsurance');
                    updateBalanceUI(); updateRoundUI(); saveGame();
                    showToast("¬°SEGURO DE VIDA UTILIZADO!", "warning");
                    log("Sistema", "Has sido salvado por tu seguro (agotado).");
                } else {
                    document.getElementById('final-round').innerText = gameState.currentRound;
                    document.getElementById('gameover-modal').style.display = 'flex';
                    setJimboEmotion('sad');
                }
            }
        }

        function resetGame() {
            document.getElementById('gameover-modal').style.display = 'none';
            startRun();
        }

        // --- Cartas ---
        function buyRandomCard() {
            if (gameState.balance < 150) {
                showToast("¬°Necesitas 150 fichas!", "error");
                return;
            }
            gameState.balance -= 150;
            updateBalanceUI(); updateRoundUI();
            const randomCard = cardPool[Math.floor(Math.random() * cardPool.length)];
            gameState.activeCards.push(randomCard);
            renderActiveCards();
            showToast(`Carta ${randomCard.name} a√±adida!`, "success");
            log("Sistema", `Robaste: ${randomCard.name}`);
        }

        function renderActiveCards() {
            const container = document.getElementById('active-cards');
            container.innerHTML = '';
            if (gameState.activeCards.length === 0) {
                container.innerHTML = '<div style="color:#666; margin:auto; font-size:0.9rem; font-style:italic;">Sin cartas... ¬°Ve a la tienda!</div>';
                return;
            }
            gameState.activeCards.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = `balatro-card ${card.color}`;
                const multDisplay = card.mult > 0 ? `x${card.mult}` : '??';
                div.innerHTML = `
                    <div class="remove-card" onclick="removeCard(${index})">√ó</div>
                    <div class="card-title">${card.name}</div>
                    <div class="card-mult">${multDisplay}</div>
                    <div class="card-effect">${card.desc}</div>
                `;
                container.appendChild(div);
            });
        }

        function removeCard(index) { gameState.activeCards.splice(index, 1); renderActiveCards(); }
        function clearCards() { gameState.activeCards = []; renderActiveCards(); }

        // --- Tienda ---
        function toggleShop() {
            const modal = document.getElementById('shop-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
        function renderShop() {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';
            shopItems.forEach(item => {
                const isOwned = gameState.inventory.includes(item.id);
                const div = document.createElement('div');
                div.className = `shop-item ${isOwned ? 'purchased' : ''} ${item.type.includes('passive') ? 'passive' : ''} ${item.type === 'active' ? 'active' : ''}`;
                
                let btnHtml = '';
                let displayPrice = item.price;

                // L√≥gica de Precio Din√°mico para el Ojo
                if (item.id === 'seerPower') {
                    displayPrice = gameState.seerPrice;
                }

                if (item.id === 'seerPower') {
                    if (isOwned) {
                        btnHtml = '<div style="color:#2ecc71;">LISTO PARA USAR</div>'; 
                    } else {
                        btnHtml = `<div class="item-price">${displayPrice}‚Ç≥</div><button class="btn-buy" onclick="buyItem('${item.id}')">COMPRAR</button>`;
                    }
                } else {
                    // Comportamiento normal para otros items
                    if (isOwned) {
                        if (item.type === 'unlock' || item.type === 'passive' || item.type === 'cosmetic') {
                            btnHtml = '<div style="color:#2ecc71;">POSE√çDO</div>';
                        } else {
                             btnHtml = '<div style="color:#2ecc71;">LISTO PARA USAR</div>';
                        }
                    } else {
                         btnHtml = `<div class="item-price">${displayPrice}‚Ç≥</div><button class="btn-buy" onclick="buyItem('${item.id}')">COMPRAR</button>`;
                    }
                }
                
                if(item.price === 0 && !isOwned) btnHtml = `<div class="item-price" style="color:#e74c3c">¬°GRATIS!</div><button class="btn-buy" onclick="buyItem('${item.id}')">ACEPTAR</button>`;

                div.innerHTML = `<div style="font-weight:bold; color:#fff;">${item.name}</div><div style="font-size:0.8rem; color:#aaa; margin:5px 0;">${item.desc}</div>${btnHtml}`;
                container.appendChild(div);
            });
        }
        function buyItem(id) {
            const item = shopItems.find(i => i.id === id);
            
            // Verificar precio din√°mico
            let finalPrice = item.price;
            if (id === 'seerPower') {
                finalPrice = gameState.seerPrice;
            }

            if (gameState.balance >= finalPrice) {
                gameState.balance -= finalPrice;
                gameState.inventory.push(id);

                // CORRECCI√ìN: SI ES EL PRESTAMISTA, DAR LAS FICHAS AHORA
                if (id === 'loanShark') {
                    gameState.balance += 2000;
                    showToast("¬°Pr√©stamo recibido! +2000‚Ç≥", "warning");
                }

                // Si es el Ojo, aumentar precio exorbitantemente (x3)
                if (id === 'seerPower') {
                    gameState.seerPrice = Math.floor(gameState.seerPrice * 3);
                    showToast("Precio del Ojo aumentado...", "info");
                }

                updateBalanceUI(); updateRoundUI(); saveGame(); renderShop(); loadInventory(); renderPowers(); startPassiveEffects();
                showToast(`Compraste ${item.name}`, "success");
            } else { showToast("Saldo insuficiente", "error"); }
        }

        // --- CORE JUEGO ---
        function initBoard() {
            const grid = document.getElementById('numbers-grid');
            while(grid.children.length > 1) { grid.removeChild(grid.lastChild); }
            for (let i = 1; i <= 36; i++) {
                const cell = document.createElement('div');
                cell.className = `bet-cell ${getColor(i) === 'red' ? 'red' : 'black'}`;
                cell.innerText = i;
                cell.onclick = () => placeBet('number', i);
                grid.appendChild(cell);
            }
        }

        function selectChip(val, el) {
            if (gameState.isSpinning) return;
            gameState.selectedChipValue = val;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function placeBet(type, value) {
            if (gameState.isSpinning) return;
            
            let betAmount = gameState.selectedChipValue;
            if (betAmount === 'all_in') {
                betAmount = gameState.balance;
            }

            if (gameState.balance < betAmount) return;

            gameState.balance -= betAmount;
            updateBalanceUI(); updateRoundUI();

            const key = `${type}_${value}`;
            if (!gameState.currentBets[key]) gameState.currentBets[key] = { type, value, amount: 0 };
            gameState.currentBets[key].amount += betAmount;

            let target;
            if (type === 'number') target = (value === 0) ? document.querySelector('.bet-cell.green') : [...document.querySelectorAll('.bet-cell')].find(el => el.innerText == value);
            else target = (value === 'red') ? document.querySelector('.btn-red') : document.querySelector('.btn-black');
            
            const existing = target.querySelector('.chip-marker');
            if(existing) existing.remove();
            
            const chip = document.createElement('div');
            chip.className = 'chip-marker';
            chip.innerText = gameState.currentBets[key].amount;
            target.appendChild(chip);
        }

        function drawWheel() {
            const cx = 150, cy = 150, r = 145, arc = (2*Math.PI)/gameState.wheelNumbers.length;
            ctx.clearRect(0,0,300,300);
            ctx.save();
            ctx.translate(cx, cy); ctx.rotate(gameState.rotation);
            gameState.wheelNumbers.forEach((n, i) => {
                ctx.beginPath();
                ctx.moveTo(0,0); ctx.arc(0,0, r, i*arc, (i+1)*arc);
                ctx.fillStyle = getNumberColor(n); ctx.fill(); ctx.stroke();
                ctx.save(); ctx.rotate(i*arc+arc/2); ctx.translate(r-20,0); ctx.rotate(Math.PI/2);
                ctx.fillStyle="#fff"; ctx.font="bold 14px Arial"; ctx.fillText(n, -4, 4); ctx.restore();
            });
            ctx.restore();
            ctx.beginPath(); ctx.moveTo(140, 5); ctx.lineTo(160, 5); ctx.lineTo(150, 30); ctx.fillStyle="#ffd700"; ctx.fill();
        }

        function spinWheel() {
            if (gameState.isSpinning || Object.keys(gameState.currentBets).length === 0) return;
            document.getElementById('prediction-box').style.opacity = '0';
            gameState.isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            document.getElementById('display-result').innerText = "?";
            gameState.speed = 0.4 + Math.random()*0.2;
            animate();
            setJimboEmotion('neutral');
        }

        function animate() {
            if (gameState.speed > 0) {
                gameState.rotation += gameState.speed;
                gameState.rotation %= 2*Math.PI;
                drawWheel();
                gameState.speed *= 0.985;
                if (gameState.speed < 0.002) { gameState.speed = 0; calculateResult(); }
                else requestAnimationFrame(animate);
            }
        }

        // --- L√ìGICA DE CONSUMO Y RESULTADOS ---
        function consumeCards() {
            const cardEls = document.querySelectorAll('.balatro-card');
            cardEls.forEach(el => el.classList.add('fading-out'));

            setTimeout(() => {
                gameState.activeCards = [];
                renderActiveCards();
            }, 800);
        }

        function calculateResult() {
            gameState.isSpinning = false;
            document.getElementById('spin-btn').disabled = false;

            let winningNum;
            if (gameState.predeterminedResult !== null) {
                winningNum = gameState.predeterminedResult;
                gameState.predeterminedResult = null;
            } else {
                const arc = (2*Math.PI)/gameState.wheelNumbers.length;
                let angle = 1.5*Math.PI - gameState.rotation;
                while (angle < 0) angle += 2*Math.PI; while (angle >= 2*Math.PI) angle -= 2*Math.PI;
                winningNum = gameState.wheelNumbers[Math.floor(angle/arc)];
            }
            let winColor = getColor(winningNum);

            gameState.activeCards.forEach(card => {
                if(card.name === 'El Duende') {
                    winningNum = 0;
                    winColor = 'green';
                    showToast("¬°El Duende fuerza el 0!", "warning");
                    document.getElementById('display-result').innerText = 0;
                    document.getElementById('display-result').style.color = "#27ae60";
                }
                if(card.name === 'Tiempo') {
                    gameState.balance += 500;
                    showToast("¬°Tiempo: +500 Fichas!", "info");
                }
            });

            document.getElementById('display-result').innerText = winningNum;
            document.getElementById('display-result').style.color = winColor === 'red' ? '#e74c3c' : (winColor === 'black' ? '#333' : '#27ae60');

            let baseWin = 0;
            let wonExactNumber = false;
            let alquimiaActive = false;

            gameState.activeCards.forEach(card => {
                if(card.name === 'Alquimia') alquimiaActive = true;
            });

            Object.values(gameState.currentBets).forEach(bet => {
                let won = false, mult = 0;
                if (bet.type === 'number' && bet.value === winningNum) { won = true; mult = 35; wonExactNumber = true; }
                else if (bet.type === 'color' && bet.value === winColor) { won = true; mult = 1; }
                
                if (!won && alquimiaActive && bet.type === 'color' && bet.value !== winColor && winColor !== 'green') {
                    won = true; mult = 1;
                    showToast("¬°Alquimia convierte la p√©rdida!", "info");
                }

                if (won) baseWin += (bet.amount * mult);
            });

            let totalMult = 1;
            
            gameState.activeCards.forEach(card => {
                let active = false;
                
                if (card.name === 'Exodia' && wonExactNumber) {
                    totalMult *= card.mult;
                    showToast("EXODIA: x100!!!", "success");
                    active = true;
                }
                else if (card.condition === 'any' && baseWin > 0) active = true;
                else if (card.condition === 'red' && winColor === 'red' && baseWin > 0) active = true;
                else if (card.condition === 'black' && winColor === 'black' && baseWin > 0) active = true;
                else if (card.condition === 'zero' && winningNum === 0 && baseWin > 0) active = true;
                else if (card.condition === 'lose' && baseWin === 0) active = true;
                else if (card.condition === 'devil_coin') active = true;
                else if (card.type === 'chaos' && baseWin > 0) {
                     const chaosMult = Math.floor(Math.random() * 21);
                     totalMult *= chaosMult;
                     showToast(`CAOS: x${chaosMult}`, "info");
                }

                if (active && card.type !== 'chaos') {
                    if (card.type === 'risk') {
                         if (Math.random() > 0.5) { totalMult *= card.mult; showToast("¬°Diablo favorece! x15", "success"); }
                         else { showToast("¬°El Diablo se lleva todo!", "error"); baseWin = -999999; }
                    } else if (card.type !== 'refund') {
                        totalMult *= card.mult;
                    }
                }
            });

            if (baseWin > 0) baseWin *= totalMult;
            if (baseWin < -1000) baseWin = 0;

            let triggerEcho = false;

            if (baseWin > 0) {
                gameState.activeCards.forEach(card => {
                    if (card.name === 'Duplicador') {
                        gameState.balance += gameState.balance;
                        showToast("¬°Duplicador de Balance!", "warning");
                    }
                    if (card.name === 'Clon') {
                        gameState.balance += (gameState.activeCards.length * 50);
                        showToast(`Clon: +${gameState.activeCards.length * 50} Fichas`, "info");
                    }
                    if (card.name === 'Bola Fantasma' && Math.random() < 0.30) {
                        triggerEcho = true;
                    }
                });

                gameState.balance += baseWin;
                setJimboEmotion('happy');
                showToast(`¬°GANASTE ${Math.floor(baseWin)}! (x${totalMult})`, "success");
                checkRoundCompletion();

                if (triggerEcho) {
                    setTimeout(() => {
                        showToast("¬°BOLA FANTASMA: TIRADA GRATIS!", "info");
                        spinWheel();
                    }, 2000);
                }

            } else {
                setJimboEmotion('sad');
                let martingalaRefund = 0;
                gameState.activeCards.forEach((card) => {
                    if(card.type === 'refund') Object.values(gameState.currentBets).forEach(bet => martingalaRefund += Math.floor(bet.amount * 0.5));
                });
                if(martingalaRefund > 0) {
                    gameState.balance += martingalaRefund;
                    showToast(`Martingala: Recuperado ${martingalaRefund}`, "warning");
                } else {
                    showToast("Perdiste...", "error");
                }
                checkGameOver();
            }

            updateBalanceUI(); updateRoundUI();
            consumeCards();

            setTimeout(() => {
                document.querySelectorAll('.chip-marker').forEach(e => e.remove());
                gameState.currentBets = {};
            }, 3000);
            
            saveGame();
        }

        // --- Utilidades ---
        function setJimboEmotion(state) {
            const pupil = document.getElementById('jimbo-pupil');
            const lid = document.getElementById('jimbo-eyelid');
            if (state === 'happy') { pupil.setAttribute('cy', '55'); lid.setAttribute('d', 'M 35 45 Q 50 35 65 45'); lid.setAttribute('opacity', '1'); }
            else if (state === 'sad') { pupil.setAttribute('cy', '60'); lid.setAttribute('d', 'M 38 65 Q 50 70 62 65'); lid.setAttribute('opacity', '1'); }
            else { pupil.setAttribute('cy', '55'); lid.setAttribute('d', ''); }
        }
        function updateBalanceUI() { document.getElementById('user-balance').innerText = gameState.balance; }
        function getNumberColor(n) {
            if (colors.red.includes(n)) return "#e74c3c";
            if (colors.black.includes(n)) return "#2c3e50";
            return "#27ae60";
        }
        function getColor(n) {
            if (colors.red.includes(n)) return 'red';
            if (colors.black.includes(n)) return 'black';
            return 'green';
        }
        function log(user, msg) {
            const logBox = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            let cls = '';
            if (user.includes('Dealer')) cls = 'log-dealer';
            if (user.includes('Sistema')) cls = 'log-jimbo';
            if (user.includes('Vidente')) cls = 'log-system';
            if (user.includes('Tragaperras')) cls = 'log-slot';
            entry.innerHTML = `<span class="${cls}">${user}:</span> ${msg}`;
            logBox.prepend(entry);
        }
        function showToast(msg, type) {
            const area = document.getElementById('notification-area');
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.borderLeftColor = type === 'error' ? '#e74c3c' : (type === 'success' ? '#2ecc71' : (type === 'warning' ? '#f1c40f' : '#000'));
            t.innerText = msg;
            area.appendChild(t);
            setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 4000);
        }
        function loadInventory() {
            // Primero, ocultar todo por defecto
            document.getElementById('chip-1000').style.display = 'none';
            document.body.classList.remove('skin-vip');
            
            gameState.inventory.forEach(id => {
                const item = shopItems.find(i => i.id === id);
                if (item && item.type === 'unlock') document.getElementById(item.target).style.display = 'flex';
                if (item && item.type === 'cosmetic') document.body.classList.add(item.target);
            });
        }
    </script>
</body>
</html>
